{% extends 'base.html' %}
{% load static %}
{% load price_filters %}

{% block title %}{{ product.name }} - E-Commerce Store{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="breadcrumb">
    <div class="breadcrumb-container">
        <a href="{% url 'products:home' %}">Home</a> >
        <span>{{ product.name }}</span>
    </div>
</nav>

<!-- Main Product Section -->
<main class="product-detail-container">
    <div class="product-detail-grid">
        <!-- Left Column: Image Gallery -->
        <div class="product-images-section">
            <div class="main-image-container">
                {% if product.primary_image %}
                    <img id="mainProductImage" src="{{ product.primary_image.url }}" alt="{{ product.name }}" class="main-product-image">
                {% elif product.image_2 %}
                    <img id="mainProductImage" src="{{ product.image_2.url }}" alt="{{ product.name }}" class="main-product-image">
                {% elif product.image_3 %}
                    <img id="mainProductImage" src="{{ product.image_3.url }}" alt="{{ product.name }}" class="main-product-image">
                {% elif product.image_4 %}
                    <img id="mainProductImage" src="{{ product.image_4.url }}" alt="{{ product.name }}" class="main-product-image">
                {% elif product.image_5 %}
                    <img id="mainProductImage" src="{{ product.image_5.url }}" alt="{{ product.name }}" class="main-product-image">
                {% else %}
                    <div id="mainProductImage" class="no-image-placeholder">
                        <span>No Image Available</span>
                    </div>
                {% endif %}
            </div>
            
            <!-- Thumbnail Gallery -->
            <div class="thumbnail-gallery" id="thumbnailGallery">
                {% if product.primary_image %}
                    <div class="thumbnail active" data-image-index="0" onclick="changeMainImage('{{ product.primary_image.url }}', 0)">
                        <img src="{{ product.primary_image.url }}" alt="{{ product.name }}">
                    </div>
                {% endif %}
                {% if product.image_2 %}
                    <div class="thumbnail {% if not product.primary_image %}active{% endif %}" data-image-index="1" onclick="changeMainImage('{{ product.image_2.url }}', 1)">
                        <img src="{{ product.image_2.url }}" alt="{{ product.name }}">
                    </div>
                {% endif %}
                {% if product.image_3 %}
                    <div class="thumbnail" data-image-index="2" onclick="changeMainImage('{{ product.image_3.url }}', 2)">
                        <img src="{{ product.image_3.url }}" alt="{{ product.name }}">
                    </div>
                {% endif %}
                {% if product.image_4 %}
                    <div class="thumbnail" data-image-index="3" onclick="changeMainImage('{{ product.image_4.url }}', 3)">
                        <img src="{{ product.image_4.url }}" alt="{{ product.name }}">
                    </div>
                {% endif %}
                {% if product.image_5 %}
                    <div class="thumbnail" data-image-index="4" onclick="changeMainImage('{{ product.image_5.url }}', 4)">
                        <img src="{{ product.image_5.url }}" alt="{{ product.name }}">
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Product Information -->
        <div class="product-info-section">
            <!-- Product Title -->
            <h1 class="product-title">{{ product.name }}</h1>
            
            <!-- Badge -->
            {% if product.badge %}
                <div class="product-badge-display">{{ product.badge }}</div>
            {% endif %}

            <!-- Pricing Section -->
            <div class="pricing-section">
                <div class="current-price">
                    <span class="price-amount">{{ product.price|format_price }}</span>
                </div>
                {% if product.original_price and product.original_price > product.price %}
                    <div class="original-price-section">
                        <span class="original-price-label">Original Price:</span>
                        <span class="original-price">{{ product.original_price|format_price }}</span>
                        {% with discount=product.get_discount_percentage %}
                            {% if discount %}
                                <span class="discount-badge">-{{ discount }}% OFF</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                {% endif %}
            </div>

            <!-- Product Details -->
            <div class="product-details">
                {% if product.material %}
                    <div class="detail-item">
                        <span class="detail-label">Material:</span>
                        <span class="detail-value">{{ product.material }}</span>
                    </div>
                {% endif %}
                
                {% if product.category %}
                    <div class="detail-item">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">{{ product.category.name }}</span>
                    </div>
                {% endif %}
                
                {% if product.rating %}
                    <div class="detail-item">
                        <span class="detail-label">Rating:</span>
                        <span class="detail-value">
                            <span class="rating-stars">★★★★★</span>
                            <span class="rating-value">{{ product.rating|floatformat:1 }}</span>
                            {% if product.review_count %}
                                <span class="review-count">({{ product.review_count }} reviews)</span>
                            {% endif %}
                        </span>
                    </div>
                {% endif %}
                
                <div class="detail-item">
                    <span class="detail-label">Availability:</span>
                    <span class="detail-value {% if product.in_stock %}in-stock{% else %}out-of-stock{% endif %}">
                        {% if product.in_stock %}
                            ✓ In Stock
                            {% if product.stock_quantity %}
                                ({{ product.stock_quantity }} available)
                            {% endif %}
                        {% else %}
                            ✗ Out of Stock
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Key Features -->
            {% if product.get_features_list %}
                <div class="features-section">
                    <h3 class="section-title">Key Features</h3>
                    <ul class="features-list">
                        {% for feature in product.get_features_list %}
                            <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- Short Description -->
            {% if product.short_description %}
                <div class="short-description-section">
                    <p class="short-description">{{ product.short_description }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Product Description Section -->
    <section class="product-description-section">
        <div class="description-tabs">
            <button class="tab-btn active" data-tab="description" onclick="switchTab('description')">Description</button>
            {% if product.get_specifications_dict %}
                <button class="tab-btn" data-tab="specifications" onclick="switchTab('specifications')">Specifications</button>
            {% endif %}
        </div>
        
        <div class="tab-content active" id="descriptionTab">
            <h2 class="section-heading">About This Product</h2>
            <div class="description-content">
                <div class="product-description-text">{{ product.description|linebreaks }}</div>
            </div>
        </div>

        {% if product.get_specifications_dict %}
            <div class="tab-content" id="specificationsTab">
                <h2 class="section-heading">Product Specifications</h2>
                <table class="specifications-table">
                    {% for key, value in product.get_specifications_dict.items %}
                        <tr>
                            <td class="spec-key">{{ key }}</td>
                            <td class="spec-value">{{ value }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        {% endif %}
    </section>

    <!-- Contact for Order Section -->
    <section class="contact-order-section">
        {% if success %}
            <div class="success-message">
                <h2>Thank you!</h2>
                <p>Your request has been sent. We will contact you soon about <strong>{{ product.name }}</strong>.</p>
            </div>
        {% else %}
            <div class="contact-form-container">
                <h2>Contact me to order this product</h2>
                <p class="form-description">Fill in your details below and we will reach out to you to complete the order. There is no online payment on this site.</p>

                {% if error %}
                    <div class="error-message">{{ error }}</div>
                {% endif %}

                <form method="post" class="contact-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone (optional)</label>
                        <input type="text" id="phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="message">Message (optional)</label>
                        <textarea id="message" name="message" rows="4">I would like to order: {{ product.name }} (Price: {{ product.price|format_price }})</textarea>
                    </div>
                    <button type="submit" class="submit-btn">Contact me for this order</button>
                </form>
            </div>
        {% endif %}
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
    // Image gallery functionality
    function changeMainImage(imageUrl, index) {
        const mainImage = document.getElementById('mainProductImage');
        if (mainImage) {
            if (mainImage.tagName === 'IMG') {
                mainImage.src = imageUrl;
            } else {
                // Replace placeholder div with img
                const img = document.createElement('img');
                img.id = 'mainProductImage';
                img.src = imageUrl;
                img.alt = '{{ product.name|escapejs }}';
                img.className = 'main-product-image';
                mainImage.parentNode.replaceChild(img, mainImage);
            }
        }
        
        // Update active thumbnail
        document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
    }
    
    // Tab switching
    function switchTab(tabName) {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to selected tab and content
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}Tab`).classList.add('active');
    }
</script>
{% endblock %}
